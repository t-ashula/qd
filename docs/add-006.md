# 機能追加 6

## transcriber モデルの追加と選択

- transcriber のモデルに openai/whisper-large-v3 を追加して， upload 時にモデルを選択できるようにする
- 個別エピソードのページでモデルの情報を表示する
- transcribe_histories テーブルを追加して，文字起こしの履歴を記録する
  - テーブルには id, episode_id, model_name, created_at を記録する
- qdrant の payload に， transcribe_history_id として追記するようにする
- episode_segments テーブルに transcribe_history_id を紐づける
- この変更により， upload 時には以下の挙動をするようにする
  1. ファイルを保存
  2. episodes テーブルに記録
  3. 指定のモデルで文字起こし
  4. 結果を transcribe_histories テーブルに記録
  5. 文字起こしの各セグメントを episode_segments テーブルに記録しつつ， qdrant の各コレクションに対してもベクトル化して記録

## 既存レコードなどのマイグレーション

- テーブルやカラムの変更のマイグレーションの後にデータのマイグレーションを行う
- 既存の episode_segments のレコードには，以下の要領で transcribe_history_id をセットするマイグレーションを実施する
  1. episodes の各レコードの分だけ， transcribe_histories テーブルにレコードを追加する．このとき， model_name は "kotoba-tech/kotoba-whisper-v2.2" とし， created_at は episodes の created_at をセットする
  2. 追加した transcribe_histories の id を episodes_segments の episode_id が一致するレコードにセットする
- transcribe_histories と episodes_segments のマイグレーションの後に， qdrant の各コレクションに対して以下の要領でマイグレーションを実施する
  1. db の transcribe_histories の各レコードを取り出す
  2. 各コレクションに対して transcribe_histories.episode_id と payload.episode_id が一致する point に対して， transcribe_histories の id と model_name をそれぞれ transcribe_history_id と model_name として payload に追記する

## 留意事項

- 変更作業をいきなり実行せず，予定をプランとして日本語で提示し，docs/add-006-plan.md として保存すること
- 必要に応じてプラン ( docs/add-006-plan.md ) を修正すること
- 修正したプラン ( docs/add-006-plan.md )  に基づいて作業すること
