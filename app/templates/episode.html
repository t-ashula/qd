{% extends "base.html" %}

{% block title %}QD - Episode: {{ episode.name }}{% endblock %}

{% block head %}
<style>
    .segment-active {
        background-color: #e2f3ff;
    }

    .audio-player {
        position: sticky;
        top: 0;
        background-color: white;
        padding: 1rem 0;
        z-index: 100;
        border-bottom: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2>{{ episode.name }}</h2>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="bi bi-trash"></i> 削除
                </button>
            </div>
            <p>
                <span class="badge bg-secondary">{{ episode.media_type }}</span>
                <span class="badge bg-info">{{ episode.bytes|int // 1024 }} KB</span>
                {% if episode.length %}
                <span class="badge bg-success">{{ episode.length|int // 60 }}:{{ "%02d"|format(episode.length|int % 60)
                    }}</span>
                {% endif %}
                <span class="badge bg-dark">{{ episode.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
            </p>
        </div>

        <div class="audio-player mb-4">
            <audio controls class="w-100" id="audio-player">
                <source src="/media/{{ episode.id }}.{{ episode.ext }}" type="{{ episode.media_type }}">
                Your browser does not support the audio element.
            </audio>
        </div>

        <h3>Transcription</h3>
        <div class="segments">
            {% for segment in episode.segments %}
            <div class="segment" id="seg{{ segment.seg_no }}">
                <div class="d-flex justify-content-between">
                    <div class="timestamp">
                        <span class="badge bg-light text-dark">{{ segment.seg_no }}</span>
                        <button class="btn btn-sm btn-outline-secondary play-segment" data-start="{{ segment.start }}"
                            data-end="{{ segment.end }}">
                            {{ segment.start|int // 60 }}:{{ "%02d"|format(segment.start|int % 60) }} -
                            {{ segment.end|int // 60 }}:{{ "%02d"|format(segment.end|int % 60) }}
                        </button>
                    </div>
                </div>
                <p class="mt-2">{{ segment.text }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">エピソードの削除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>エピソード「{{ episode.name }}」を削除してもよろしいですか？</p>
                <p class="text-danger">この操作は取り消せません。エピソードのデータ、メディアファイル、検索インデックスがすべて削除されます。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <form id="deleteForm" method="POST">
                    <button type="submit" class="btn btn-danger">削除する</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const audioPlayer = document.getElementById('audio-player');
        const segments = document.querySelectorAll('.segment');
        const playButtons = document.querySelectorAll('.play-segment');

        // Handle segment play buttons
        playButtons.forEach(button => {
            button.addEventListener('click', function () {
                const start = parseFloat(this.getAttribute('data-start'));
                const end = parseFloat(this.getAttribute('data-end'));

                // Set current time and play
                audioPlayer.currentTime = start;
                audioPlayer.play();

                // Highlight active segment
                segments.forEach(seg => seg.classList.remove('segment-active'));
                this.closest('.segment').classList.add('segment-active');

                // Stop at end time
                const checkTime = function () {
                    if (audioPlayer.currentTime >= end) {
                        audioPlayer.pause();
                        audioPlayer.removeEventListener('timeupdate', checkTime);
                    }
                };

                audioPlayer.addEventListener('timeupdate', checkTime);
            });
        });

        // Handle hash navigation
        if (window.location.hash) {
            const targetSegment = document.querySelector(window.location.hash);
            if (targetSegment) {
                targetSegment.scrollIntoView();
                targetSegment.classList.add('segment-active');
            }
        }
    });

    // Set up delete form
    document.addEventListener('DOMContentLoaded', function () {
        const deleteForm = document.getElementById('deleteForm');
        deleteForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // Send DELETE request
            fetch('/episodes/{{ episode.id }}', {
                method: 'DELETE',
            }).then(response => {
                if (response.ok || response.redirected) {
                    window.location.href = '/episodes';
                } else {
                    alert('削除に失敗しました。');
                }
            }).catch(error => {
                console.error('Error:', error);
                alert('削除に失敗しました。');
            });
        });
    });
</script>
{% endblock %}